jenkins:
  systemMessage: "Jenkins configured automatically by JCasC"
  numExecutors: 2
  mode: NORMAL
  scmCheckoutRetryCount: 2
  securityRealm:
    local:
      allowsSignup: false
      users:
       - id: "admin"
         password: "admin"
  authorizationStrategy:
    loggedInUsersCanDoAnything:
      allowAnonymousRead: false

credentials:
  system:
    domainCredentials:
      - credentials:
          - basicSSHUserPrivateKey:
              scope: GLOBAL
              id: "ssh-credentials"
              username: "root"
              privateKeySource:
                directEntry:
                  privateKey: |
                    -----BEGIN OPENSSH PRIVATE KEY-----
                    b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
                    QyNTUxOQAAACCEuL1XZ1yNazGZaRM+sDpgwmAmp2ocxVdudoCD6pARcgAAAJjVUBVS1VAV
                    UgAAAAtzc2gtZWQyNTUxOQAAACCEuL1XZ1yNazGZaRM+sDpgwmAmp2ocxVdudoCD6pARcg
                    AAAEACubIs3LfoqDCJxzf6MK7Jbl/DEe+nw2F+wZosxtTq+4S4vVdnXI1rMZlpEz6wOmDC
                    YCanahzFV252gIPqkBFyAAAAFWplbmtpbnNAdG9uaWxvZ2FyLmNvbQ==
                    -----END OPENSSH PRIVATE KEY-----
          - string:
              scope: GLOBAL
              id: "hcloud-token"
              secret: "${HCLOUD_TOKEN}"
          - string:
              scope: GLOBAL
              id: "hetzner-dns-token"
              secret: "${HETZNER_DNS_TOKEN}"

jobs:
  - script: >
      pipelineJob('Deploy-App') {
        definition {
          cps {
            sandbox(true)
            script('''
              pipeline {
                agent any
                stages {
                  stage('Deploy') {
                    steps {
                      dir('/home/a.lopez.g/Documents/trabajos/jenkins_container/003_app') {
                        sh 'docker compose --env-file ../env.development -p 003_app up -d --build'
                        sh 'docker compose --env-file ../env.development -p 003_app ps'
                      }
                    }
                  }
                }
              }
            ''')
          }
        }
      }
  - script: >
      pipelineJob('Stop-App') {
        definition {
          cps {
            sandbox(true)
            script('''
              pipeline {
                agent any
                stages {
                  stage('Stop') {
                    steps {
                      dir('/home/a.lopez.g/Documents/trabajos/jenkins_container/003_app') {
                        sh 'docker compose --env-file ../env.development -p 003_app down'
                      }
                    }
                  }
                }
              }
            ''')
          }
        }
      }
  - script: >
      pipelineJob('Deploy-Infrastructure') {
        parameters {
          choiceParam('ACTION', ['plan', 'apply', 'destroy'], 'Terraform action to perform')
          booleanParam('CONFIRM', false, 'Confirm execution (required for apply/destroy)')
        }
        definition {
          cps {
            sandbox(true)
            script('''
              pipeline {
                agent any
                environment {
                  HCLOUD_TOKEN = credentials('hcloud-token')
                }
                stages {
                  stage('Init') {
                    steps {
                      withCredentials([sshUserPrivateKey(credentialsId: 'ssh-credentials', keyFileVariable: 'SSH_KEY_FILE')]) {
                        dir('/home/a.lopez.g/Documents/trabajos/jenkins_container/002_terraform') {
                          script {
                            env.PUBLIC_KEY = sh(script: 'ssh-keygen -y -f $SSH_KEY_FILE', returnStdout: true).trim()
                            sh """
                              set -a
                              . ../env.development
                              set +a
                              terraform init
                            """
                          }
                        }
                      }
                    }
                  }
                  stage('Action') {
                    steps {
                      withCredentials([sshUserPrivateKey(credentialsId: 'ssh-credentials', keyFileVariable: 'SSH_KEY_FILE'), string(credentialsId: 'hcloud-token', variable: 'HCLOUD_TOKEN')]) {
                        dir('/home/a.lopez.g/Documents/trabajos/jenkins_container/002_terraform') {
                          script {
                            if (params.ACTION == 'plan') {
                              sh 'set -a && . ../env.development && set +a && terraform plan -var="hcloud_token=$HCLOUD_TOKEN" -var="ssh_public_key=$PUBLIC_KEY"'
                            } else if (params.ACTION == 'apply') {
                              if (params.CONFIRM) {
                                sh 'set -a && . ../env.development && set +a && terraform apply -auto-approve -var="hcloud_token=$HCLOUD_TOKEN" -var="ssh_public_key=$PUBLIC_KEY"'
                              } else {
                                error "Confirmation required for APPLY action"
                              }
                            } else if (params.ACTION == 'destroy') {
                              if (params.CONFIRM) {
                                sh 'set -a && . ../env.development && set +a && terraform destroy -auto-approve -var="hcloud_token=$HCLOUD_TOKEN" -var="ssh_public_key=$PUBLIC_KEY"'
                              } else {
                                error "Confirmation required for DESTROY action"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            ''')
          }
        }
      }
  - script: >
      pipelineJob('Deploy-Production') {
        parameters {
          booleanParam('CONFIRM', false, 'Confirm deployment to production VPS')
          choiceParam('BRANCH_NAME', ['main', 'main_dev_pro'], 'Select branch to deploy')
        }
        definition {
          cps {
            sandbox(true)
            script('''
              pipeline {
                agent any
                environment {
                  VPS_USER = 'root'
                  VPS_PATH = '/opt/app'
                  PROJECT_DIR = '/home/a.lopez.g/Documents/trabajos/jenkins_container'
                  VPS_IP = '162.55.220.151'
                }
                stages {
                  stage('Validate') {
                    steps {
                      script {
                        if (!params.CONFIRM) {
                          error "Deployment must be confirmed with the CONFIRM parameter"
                        }
                      }
                    }
                  }
                  stages {
                    stage('Checkout') {
                      steps {
                        git branch: "${params.BRANCH_NAME}", url: 'git@github.com:tonilogardev/jenkins_container.git', credentialsId: 'ssh-credentials'
                      }
                    }
                    stage('Copy Files to VPS') {
                      steps {
                        withCredentials([sshUserPrivateKey(credentialsId: 'ssh-credentials', keyFileVariable: 'SSH_KEY')]) {
                          sh """
                            timeout=300
                            elapsed=0
                            interval=10
                            while ! ssh -o StrictHostKeyChecking=no -i \\$SSH_KEY \\$VPS_USER@\\$VPS_IP "command -v docker" > /dev/null 2>&1; do
                              if [ \\$elapsed -ge \\$timeout ]; then
                                echo "Timeout waiting for Docker to be installed"
                                exit 1
                              fi
                              echo "Waiting for Docker to be installed... (\\$elapsed/\\$timeout seconds)"
                              sleep \\$interval
                              elapsed=\\$((elapsed + interval))
                            done
                            echo "Docker is ready!"
                            
                            ssh -o StrictHostKeyChecking=no -i \\$SSH_KEY \\$VPS_USER@\\$VPS_IP "mkdir -p \\$VPS_PATH"
                            rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no -i \\$SSH_KEY" \
                              003_app/ \\$VPS_USER@\\$VPS_IP:\\$VPS_PATH/
                            scp -o StrictHostKeyChecking=no -i \\$SSH_KEY \
                              /home/a.lopez.g/Documents/trabajos/jenkins_container/env.production \\$VPS_USER@\\$VPS_IP:\\$VPS_PATH/.env
                          """
                        }
                      }
                    }
                  stage('Deploy on VPS') {
                    steps {
                      withCredentials([sshUserPrivateKey(credentialsId: 'ssh-credentials', keyFileVariable: 'SSH_KEY'), string(credentialsId: 'hcloud-token', variable: 'HCLOUD_TOKEN')]) {
                        sh """
                          ssh -o StrictHostKeyChecking=no -i \\$SSH_KEY \\$VPS_USER@\\$VPS_IP "export HCLOUD_TOKEN=\\$HCLOUD_TOKEN && cd \\$VPS_PATH && docker compose --env-file .env --profile production up -d --build"
                        """
                      }
                    }
                  }
                }
                post {
                  success {
                    echo "Deployed successfully to https://tonilogar.com"
                  }
                }
              }
            ''')
          }
        }
      }
